@model MIEL.web.Models.ViewModel.SalesVM
@{
    ViewData["Title"] = "Create Sales";
    Layout = "_AdminLayout";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container-fluid">
    <h4 class="mb-3">Create Sales</h4>

    <form asp-action="Create" method="post">

        <div class="row mb-3">
            <div class="col-md-3">
                <label>Invoice No</label>
                <input asp-for="InvoiceNo" class="form-control" readonly />
            </div>

            <div class="col-md-3">
                <label>Date</label>
                <input asp-for="SalesDate" type="date" class="form-control" />
            </div>

            <div class="col-md-3">
                <label>Customer</label>
                <select id="CustomerId" name="CustomerId" class="form-select"></select>

            </div>

            <div class="col-md-3">
                <label>Payment</label>
                <select asp-for="PaymentType" class="form-select">
                    <option>Cash</option>
                    <option>Pay_ID</option>
                   
                </select>
            </div>
        </div>

        <hr />

        <div class="row mb-3">
            <div class="col-md-3">
                <label>Product</label>
                <select id="ProductId" class="form-select"></select>
            </div>

            <div class="col-md-2">
                <label>Variant</label>
                <select id="VariantId" class="form-select"></select>
            </div>

            <div class="col-md-2">
                <label>Batch</label>
                <select id="BatchNo" class="form-select"></select>
            </div>

            <div class="col-md-1">
                <label>Stock</label>
                <input id="AvailableQty" class="form-control" readonly />
            </div>

            <div class="col-md-1">
                <label>Price</label>
                <input id="SellingPrice" class="form-control" readonly />
            </div>

            <div class="col-md-1">
                <label>Qty</label>
                <input id="Quantity" type="number" value="1" class="form-control" />
            </div>

            <div class="col-md-1">
                <label>Disc %</label>
                <input id="DiscPercent" type="number" class="form-control" />
            </div>

            <div class="col-md-1">
                <label>Disc Amt</label>
                <input id="DiscAmount" type="number" class="form-control" />
            </div>

            <div class="col-md-1 d-flex align-items-end">
                <button type="button" id="btnAdd" class="btn btn-primary w-100">Add</button>
            </div>
        </div>

        <div id="hiddenItems"></div>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Variant</th>
                    <th>Batch</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Disc %</th>
                    <th>Disc Amt</th>
                    <th>GST</th>
                    <th>Net</th>
                    <th></th>
                </tr>
            </thead>

            <tbody id="itemsBody"></tbody>
        </table>

        <div class="text-end">
            <h5>Discount: <span id="lblDiscount">0.00</span></h5>
            <h5>GST: <span id="lblGst">0.00</span></h5>
            <h4>Total: <span id="lblNet">0.00</span></h4>
        </div>

        <div class="text-end mt-3">
            <button type="submit" class="btn btn-success">Save</button>
        </div>

        <input type="hidden" name="TotalAmount" id="hdTotalAmount" />
        <input type="hidden" name="TotalDiscount" id="hdTotalDiscount" />
        <input type="hidden" name="GstAmount" id="hdGstAmount" />
        <input type="hidden" name="NetAmount" id="hdNetAmount" />

    </form>

</div>

<!-- ================= script ================= -->
<script>
    let itemIndex = 0;

    $(document).ready(function () {

        // =====================================================
        // PRODUCT SEARCH (SELECT2)
        // =====================================================
        $('#ProductId').select2({
            width: '100%',
            placeholder: "Search Product",
            minimumInputLength: 1,
            ajax: {
                url: '/Sales/SearchProducts',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { term: params.term };
                },
                processResults: function (data) {
                    return {
                        results: $.map(data, function (item) {
                            return { id: item.id, text: item.text };
                        })
                    };
                }
            }
        });

     // =====================================================
    // CUSTOMER SEARCH (SELECT2)
    // =====================================================
      $('#CustomerId').select2({
        width: '100%',
        placeholder: "Search Customer",
        minimumInputLength: 1,
        ajax: {
            url: '/Sales/SearchCustomers',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { term: params.term };
            },
            processResults: function (data) {
                return {
                    results: $.map(data, function (cust) {
                        return {
                            id: cust.id,
                            text: cust.text
                        };
                    })
                };
            }
        }
    });







        // =====================================================
        // LOAD VARIANTS
        // =====================================================
        $('#ProductId').on('change', function () {

            let productId = $(this).val();

            $('#VariantId').empty().append('<option value="">-- Select Variant --</option>');
            $('#BatchNo').empty().append('<option value="">-- Select Batch --</option>');
            $('#AvailableQty').val('');
            $('#SellingPrice').val('');

            if (!productId) return;

            $.get('/Sales/GetVariants',
                { productId: productId },
                function (data) {

                    $.each(data, function (i, item) {
                        $('#VariantId').append(
                            `<option value="${item.id}">${item.text}</option>`
                        );
                    });
                });
        });

        // =====================================================
        // LOAD BATCHES
        // =====================================================
        $('#VariantId').on('change', function () {

            let variantId = $(this).val();

            $('#BatchNo').empty().append('<option value="">-- Select Batch --</option>');
            $('#AvailableQty').val('');
            $('#SellingPrice').val('');

            if (!variantId) return;

            $.get('/Sales/GetBatches',
                { variantId: variantId },
                function (data) {

                    $.each(data, function (i, item) {
                        $('#BatchNo').append(
                            `<option value="${item.batchNo}">
                                ${item.batchNo} (Stock: ${item.availableQty})
                             </option>`
                        );
                    });
                });
        });

        // =====================================================
        // LOAD STOCK + SELLING PRICE
        // =====================================================
        $('#BatchNo').on('change', function () {

            let batchNo = $(this).val();
            let variantId = $('#VariantId').val();

            $('#AvailableQty').val('');
            $('#SellingPrice').val('');

            if (!batchNo || !variantId) return;

            $.get('/Sales/GetBatchDetails',
                {
                    variantId: variantId,
                    batchNo: batchNo
                },
                function (data) {

                    if (data) {
                        $('#AvailableQty').val(data.availableQty);
                        $('#SellingPrice').val(data.sellingPrice);
                    }
                });
        });

        // =====================================================
        // DISCOUNT CALCULATION
        // =====================================================
        $('#DiscPercent').on('input', function () {

            let price = parseFloat($('#SellingPrice').val()) || 0;
            let qty = parseInt($('#Quantity').val()) || 0;
            let percent = parseFloat($(this).val()) || 0;

            let gross = price * qty;
            let discAmt = (gross * percent) / 100;

            $('#DiscAmount').val(discAmt.toFixed(2));
        });

        $('#DiscAmount').on('input', function () {

            let price = parseFloat($('#SellingPrice').val()) || 0;
            let qty = parseInt($('#Quantity').val()) || 0;
            let amount = parseFloat($(this).val()) || 0;

            let gross = price * qty;
            if (gross === 0) return;

            let percent = (amount / gross) * 100;
            $('#DiscPercent').val(percent.toFixed(2));
        });

        // =====================================================
        // ADD ITEM
        // =====================================================
           $('#btnAdd').on('click', function ()
    {

            let productData = $('#ProductId').select2('data');

            if (!productData || productData.length === 0) {
                alert("Select product first");
                return;
            }

            let productName = productData[0].text;
            let variantId = $('#VariantId').val();
            let variantText = $('#VariantId option:selected').text();
            let batchNo = $('#BatchNo').val();
            let available = parseInt($('#AvailableQty').val()) || 0;
            let price = parseFloat($('#SellingPrice').val()) || 0;
            let qty = parseInt($('#Quantity').val()) || 1;
            let discPercent = parseFloat($('#DiscPercent').val()) || 0;
            let discAmount = parseFloat($('#DiscAmount').val()) || 0;

            if (!variantId || !batchNo) {
                alert("Select product, variant and batch");
                return;
            }

            if (qty <= 0) {
                alert("Quantity must be greater than zero");
                return;
            }

            if (available <= 0) {
                alert("No stock available for this batch");
                return;
            }

            if (qty > available) {
                alert("Insufficient stock available");
                return;
            }

            // PREVENT DUPLICATE
            if ($(`tr[data-key="${variantId}-${batchNo}"]`).length > 0) {
                alert("This batch already added");
                return;
            }

            let gross = price * qty;
            let taxable = gross - discAmount;

            // GST INCLUDED (10%)
            let gst = taxable * 10 / 110;
            let net = taxable;

            // ADD ROW
            let row = `
                <tr data-key="${variantId}-${batchNo}">
                    <td>${productName}</td>
                    <td>${variantText}</td>
                    <td>${batchNo}</td>
                    <td class="text-end">${price.toFixed(2)}</td>
                    <td class="text-end">${qty}</td>
                    <td class="text-end">${discPercent.toFixed(2)}%</td>
                    <td class="text-end">${discAmount.toFixed(2)}</td>
                    <td class="text-end">${gst.toFixed(2)}</td>
                    <td class="text-end">${net.toFixed(2)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger btn-remove">✖</button>
                    </td>
                </tr>`;

           $('#itemsBody').append(row);


            // HIDDEN INPUTS
            $('#hiddenItems').append(`
                <div class="hidden-item" data-key="${variantId}-${batchNo}">
                    <input type="hidden" name="Items[${itemIndex}].varientid" value="${variantId}" />
                    <input type="hidden" name="Items[${itemIndex}].BatchNo" value="${batchNo}" />
                    <input type="hidden" name="Items[${itemIndex}].Quantity" value="${qty}" />
                    <input type="hidden" name="Items[${itemIndex}].SellingPrice" value="${price}" />
                    <input type="hidden" name="Items[${itemIndex}].DiscPercent" value="${discPercent}" />
                    <input type="hidden" name="Items[${itemIndex}].DiscAmount" value="${discAmount}" />
                    <input type="hidden" name="Items[${itemIndex}].TaxAmount" value="${gst}" />
                    <input type="hidden" name="Items[${itemIndex}].NetAmount" value="${net}" />
                </div>
            `);

            itemIndex++;

            calculateTotals();
            resetFields();
        });

        // =====================================================
        // REMOVE ITEM
        // =====================================================
        $(document).on('click', '.btn-remove', function () {

            let row = $(this).closest('tr');
            let key = row.data('key');

            row.remove();
            $(`.hidden-item[data-key="${key}"]`).remove();

            calculateTotals();
        });

    });

    // =====================================================
    // CALCULATE TOTALS
    // =====================================================
    function calculateTotals() {

        let totalDiscount = 0;
        let totalGst = 0;
        let netTotal = 0;

        $('#hiddenItems .hidden-item').each(function () {

            totalDiscount += parseFloat($(this).find('[name$=".DiscAmount"]').val()) || 0;
            totalGst += parseFloat($(this).find('[name$=".TaxAmount"]').val()) || 0;
            netTotal += parseFloat($(this).find('[name$=".NetAmount"]').val()) || 0;
        });

        $('#lblDiscount').text(totalDiscount.toFixed(2));

        $('#lblGst').text(totalGst.toFixed(2));
        $('#lblNet').text(netTotal.toFixed(2));

        // IMPORTANT → Send to controller
        $('#hdTotalAmount').val(netTotal.toFixed(2));
        $('#hdTotalDiscount').val(totalDiscount.toFixed(2));
        $('#hdGstAmount').val(totalGst.toFixed(2));
        $('#hdNetAmount').val(netTotal.toFixed(2));
    }

    // =====================================================
    // RESET FIELDS
    // =====================================================
        function resetFields() {

        $('#Quantity').val(1);
        $('#DiscPercent').val('');
        $('#DiscAmount').val('');

        $('#VariantId').val('').trigger('change');
        $('#BatchNo').empty().append('<option value="">-- Select Batch --</option>');

        $('#AvailableQty').val('');
        $('#SellingPrice').val('');
    }

</script>
