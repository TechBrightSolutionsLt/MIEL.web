@model MIEL.web.Models.ViewModel.CategorySpecificationVM

@{
    ViewData["Title"] = "Category Specification";
    Layout = "_AdminLayout";
}

<!-- PAGE HEADER -->
<div class="mb-4">
    <h2 class="mb-1">Add Category Specifications</h2>
    <small class="text-muted">Create and manage specifications for each category</small>
</div>

<form id="specForm">

    <div class="card shadow-sm border-0">
        <div class="card-body">

            <!-- CATEGORY -->
            <div class="mb-4">
                <label class="form-label">Select Category</label>

                <select asp-for="SelectedCategoryId"
                        name="SelectedCategoryId"
                        asp-items="Model.Categories"
                        id="SelectedCategoryId"
                        class="form-select">
                    <option value="">-- Select Category --</option>
                </select>
            </div>

            <!-- SPEC INPUT -->
            <div class="mb-4">

                <label class="form-label">Specification Name</label>
                <input type="text"
                       id="SpecName"
                       name="SpecName"
                       class="form-control mb-2"
                       placeholder="e.g. Length, Fabric, Sleeve Type" />


                <label class="form-label">Options</label>
                <textarea id="Option"
                          name="Options"
                          class="form-control mb-2"
                          placeholder="Ex: S,M,L,XL"></textarea>

                <label class="form-label">Option Type</label>
                <select id="OptionType" name="OptionType" class="form-select mb-3">
                    <option value="">-- Select Option Type --</option>
                    <option value="Textbox">Textbox</option>
                    <option value="Checkbox">Checkbox</option>
                </select>

                <div class="d-flex gap-2">
                    <button type="submit"
                            id="btnSave"
                            class="btn btn-primary">
                        Add
                    </button>
                </div>

                <input type="hidden" id="Id" value="0" />

            </div>

            <!-- TABLE -->
            <div class="mt-4">

                <h5 class="mb-3">Specifications</h5>

                <table class="table table-bordered align-middle" id="specTable">
                    <thead class="table-light">
                        <tr>
                            <th>Specification Name</th>
                            <th style="width:120px;">Delete</th>
                        </tr>
                    </thead>

                    <tbody></tbody>

                </table>

            </div>

        </div>
    </div>

</form>

@section Scripts {

    <script>

        let isEditing = false;

        document.getElementById("specForm")
        .addEventListener("submit", function (e) {
            e.preventDefault();
            saveSpecification();
        });

               document.getElementById("SelectedCategoryId")
        .addEventListener("change", function () {

            isEditing = false;   // reset editing mode

            document.getElementById("Id").value = 0;
            document.getElementById("SpecName").value = "";
            document.getElementById("Option").value = "";
            document.getElementById("OptionType").value = "";
            document.getElementById("btnSave").innerText = "Add";

            let categoryId = this.value;

            if (categoryId) {
                loadSpecifications(categoryId);
            } else {
                document.querySelector("#specTable tbody").innerHTML = "";
            }
        });

        function loadSpecifications(categoryId) {

            fetch(`@Url.Action("GetSpecifications", "CategorySpecification")?categoryId=${categoryId}`)
                .then(res => res.json())
                .then(data => {

                    let rows = "";

                    data.forEach(item => {

                        rows += `
                        <tr>
                            <td>
                                <button type="button"
                                    class="btn btn-link p-0 text-decoration-none"
                                    onclick='editSpec(${item.id},
                                        "${item.specName}",
                                        "${item.options ?? ""}",
                                        "${item.optionType ?? ""}")'>
                                    ${item.specName}
                                </button>
                            </td>

                            <td>
                                <button class="btn btn-danger btn-sm"
                                    onclick="deleteSpec(${item.id})">
                                    Delete
                                </button>
                            </td>
                        </tr>`;
                    });

                    document.querySelector("#specTable tbody").innerHTML = rows;
                });
        }

        function saveSpecification() {

            let model = {
                Id: parseInt(document.getElementById("Id").value || 0),
                SpecName: document.getElementById("SpecName").value || "",
                Options: document.getElementById("Option").value || "",
                OptionType: document.getElementById("OptionType").value || "",
                SelectedCategoryId: parseInt(document.getElementById("SelectedCategoryId").value || 0)
            };

            if (!model.SelectedCategoryId) {
                alert("Please select category");
                return;
            }

            if (model.SpecName.trim() === "") {
                alert("Enter specification name");
                return;
            }

            if (model.OptionType === "") {
                alert("Select option type");
                return;
            }

            fetch("@Url.Action("SaveSpecification", "CategorySpecification")", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(model)
                })
                .then(res => res.json())
                .then(response => {

                    if (!response.success) {
                        alert(response.message);
                        return;
                    }

                    isEditing = false;

                    document.getElementById("Id").value = 0;
                    document.getElementById("SpecName").value = "";
                    document.getElementById("Option").value = "";
                    document.getElementById("OptionType").value = "";

                    document.getElementById("btnSave").innerText = "Add";

                    loadSpecifications(model.SelectedCategoryId);
                });

        }

        function editSpec(id, specName, options, optionType) {

            isEditing = true;

            document.getElementById("Id").value = id;
            document.getElementById("SpecName").value = specName || "";
            document.getElementById("Option").value = options || "";
            document.getElementById("OptionType").value = optionType || "";

            document.getElementById("btnSave").innerText = "Update";
        }

        /* ============================
           DELETE
        ============================ */

        function deleteSpec(id) {

            if (!confirm("Delete this specification?"))
                return;

            fetch("@Url.Action("DeleteSpecification", "CategorySpecification")", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `id=${id}`
            })
            .then(() => {

                let catId = document.getElementById("SelectedCategoryId").value;
                loadSpecifications(catId);
            });
        }

    </script>

}