@model MIEL.web.Models.ViewModel.ProductListVM

<div class="container py-5">
    <div class="row align-items-start">

        <!-- ================= THUMBNAILS ================= -->
        <div class="col-lg-1 col-md-2">
            <div class="thumbnail-column">
                <img src="@Model.ImagePath"
                     class="thumb-img active"
                     onmouseover="changeImage(this)" />

                @if (Model.Images != null && Model.Images.Any())
                {
                    foreach (var img in Model.Images)
                    {
                        <img src="@img"
                             class="thumb-img"
                             onmouseover="changeImage(this)" />
                    }
                }
            </div>
        </div>

        <!-- ================= MAIN IMAGE ================= -->
        <div class="col-lg-4 col-md-5 position-relative">
            <div class="main-image" id="mainImageContainer">
                <img id="mainProductImage"
                     src="@Model.ImagePath"
                     alt="@Model.ProductName" />
                <div id="zoomLens"></div>
            </div>
            <div id="zoomResult"></div>
        </div>

        <!-- ================= PRODUCT DETAILS ================= -->
        <div class="col-lg-4 col-md-5">

            <h2 class="product-title">@Model.ProductName</h2>
            <p class="product-brand">@Model.Brand</p>

            <h6>MRP RS.</h6>
           
            <p class="product-title" id="productPrice">₹ @Model.NetAmount</p>

            <!-- ================= COLOR ================= -->
            @if (Model.Variants != null && Model.Variants.Any())
            {
                var colors = Model.Variants.Select(v => v.Color).Distinct().ToList();

                <div class="variant-box">
                    <h6>Color</h6>
                    <div class="variant-options" id="colorContainer">
                        @foreach (var color in colors)
                        {
                            <span class="variant-pill color-pill"
                                  data-color="@color">
                                @color
                            </span>
                        }
                    </div>
                </div>
            }

            <!-- ================= SIZE ================= -->
            <div class="variant-box">
                <h6>Size</h6>
                <div class="variant-options" id="sizeContainer">
                    <!-- sizes load dynamically -->
                </div>
            </div>

            <div id="sizeError" class="text-danger" style="display:none;">
                Please select a size
            </div>

            <!-- ================= BUTTONS ================= -->
            <div class="mt-4">
                <button class="btn btn-outline-dark me-3"
                        onclick="addToCart(@Model.ProductId)">
                    Add to Cart
                </button>

                <button class="btn btn-buy">
                    Buy Now
                </button>
            </div>

            <!-- ================= HIGHLIGHTS ================= -->
            @if (Model.Specificationsnew != null && Model.Specificationsnew.Any())
            {
                <div class="highlight-box mt-5">
                    <h5>Product Highlights</h5>
                    @foreach (var spec in Model.Specificationsnew)
                    {
                        <div class="highlight-row">
                            <strong>@spec.SpecName</strong> : @spec.SpecValue
                        </div>
                    }
                </div>
            }

        </div>
    </div>
</div>

<!-- ================= STYLES ================= -->
<style>
    .thumbnail-column {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .thumb-img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border: 1px solid #ddd;
        cursor: pointer;
        padding: 3px;
    }

        .thumb-img.active {
            border: 2px solid #000;
        }

    .main-image {
        position: relative;
        width: 100%;
        height: 480px;
        border: 1px solid #eee;
        overflow: hidden;
    }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    #zoomLens {
        position: absolute;
        border: 1px solid #000;
        width: 180px;
        height: 180px;
        display: none;
        background: rgba(255,255,255,0.4);
        pointer-events: none;
    }

    #zoomResult {
        position: absolute;
        top: 0;
        left: 105%;
        width: 380px;
        height: 480px;
        border: 1px solid #eee;
        background-repeat: no-repeat;
        display: none;
        background-color: #fff;
        z-index: 10;
    }

    .product-title {
        font-weight: 700;
        font-size: 26px;
    }

    .product-brand {
        color: #888;
        font-size: 13px;
        text-transform: uppercase;
    }

    .variant-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .variant-pill {
        padding: 8px 16px;
        border: 1px solid #ccc;
        border-radius: 25px;
        cursor: pointer;
        background: #fff;
    }

        .variant-pill.active {
            background: #000;
            color: #fff;
        }

    .btn-buy {
        background: #d32f2f;
        color: #fff;
        border: none;
        padding: 10px 30px;
        border-radius: 6px;
        font-weight: 600;
    }

    .highlight-box {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
    }
</style>

<!-- ================= VARIANT DATA ================= -->
<script>
    const productVariants = @Html.Raw(
                System.Text.Json.JsonSerializer.Serialize(Model.Variants)
        );
</script>

<!-- ================= SCRIPT ================= -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        /* ================= ZOOM SECTION (YOUR ORIGINAL - CLEANED) ================= */

        const img = document.getElementById("mainProductImage");
        const lens = document.getElementById("zoomLens");
        const result = document.getElementById("zoomResult");

        function initZoom() {
            if (!img || !lens || !result) return;

            result.style.backgroundImage = `url('${img.src}')`;

            const cx = result.offsetWidth / lens.offsetWidth;
            const cy = result.offsetHeight / lens.offsetHeight;

            result.style.backgroundSize =
                (img.width * cx) + "px " +
                (img.height * cy) + "px";
        }

        function moveLens(e) {

            const rect = img.getBoundingClientRect();

            let x = e.clientX - rect.left - lens.offsetWidth / 2;
            let y = e.clientY - rect.top - lens.offsetHeight / 2;

            if (x < 0) x = 0;
            if (y < 0) y = 0;
            if (x > rect.width - lens.offsetWidth)
                x = rect.width - lens.offsetWidth;

            if (y > rect.height - lens.offsetHeight)
                y = rect.height - lens.offsetHeight;

            lens.style.left = x + "px";
            lens.style.top = y + "px";

            const cx = result.offsetWidth / lens.offsetWidth;
            const cy = result.offsetHeight / lens.offsetHeight;

            result.style.backgroundPosition =
                "-" + (x * cx) + "px -" + (y * cy) + "px";
        }

        if (img) {
            img.addEventListener("mouseenter", () => {
                lens.style.display = "block";
                result.style.display = "block";
                initZoom();
            });

            img.addEventListener("mousemove", moveLens);
            lens.addEventListener("mousemove", moveLens);

            img.addEventListener("mouseleave", () => {
                lens.style.display = "none";
                result.style.display = "none";
            });
        }

        window.changeImage = function (el) {
            document.querySelectorAll(".thumb-img")
                .forEach(i => i.classList.remove("active"));

            el.classList.add("active");
            img.src = el.src;

            setTimeout(initZoom, 100);
        };

        /* ================= VARIANT SECTION ================= */

        let selectedColor = null;
        let selectedSize = null;

        const colorPills = document.querySelectorAll(".color-pill");
        const sizeContainer = document.getElementById("sizeContainer");

        colorPills.forEach(pill => {
            pill.addEventListener("click", function () {

                colorPills.forEach(p => p.classList.remove("active"));
                this.classList.add("active");

                selectedColor = this.dataset.color;
                loadSizesByColor(selectedColor);
            });
        });

        function loadSizesByColor(color) {

            sizeContainer.innerHTML = "";
            selectedSize = null;

            const filtered = productVariants
                .filter(v => v.Color === color)
                .map(v => v.Size);

            const uniqueSizes = [...new Set(filtered)];

            uniqueSizes.forEach(size => {

                const span = document.createElement("span");
                span.className = "variant-pill size-pill";
                span.innerText = size;

                 span.addEventListener("click", function () {

        document.querySelectorAll(".size-pill")
            .forEach(s => s.classList.remove("active"));

        this.classList.add("active");

        selectedSize = size;

        document.getElementById("sizeError").style.display = "none";

        // 🔥 CHANGE PRICE HERE
        const matchedVariant = productVariants.find(v =>
            v.Color === selectedColor &&
            v.Size === selectedSize
        );

        if (matchedVariant) {
            document.getElementById("productPrice")
                .innerText = "₹ " + matchedVariant.Rate;
        }
    });


                sizeContainer.appendChild(span);
            });
        }

        // Auto select first color
        if (colorPills.length > 0) {
            colorPills[0].click();
        }

        /* ================= ADD TO CART ================= */

        window.addToCart = function (productId) {

            if (!selectedColor) {
                alert("Please select a color");
                return;
            }

            if (!selectedSize) {
                document.getElementById("sizeError").style.display = "block";
                return;
            }

            fetch('/Home/AddToCart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: 1,
                    color: selectedColor,
                    size: selectedSize
                })
            })
            .then(res => res.json())
            .then(data => {

                if (data.success) {

                    // Update cart count
                    fetch('/Home/GetCartCount')
                        .then(res => res.json())
                        .then(c => {
                            const cartCount =
                                document.getElementById("cartCount");
                            if (cartCount) {
                                cartCount.textContent = c.count;
                            }
                        });

                    alert("Added to cart successfully");
                }
                else {
                    alert("Something went wrong");
                }
            });
        };

    });
</script>

