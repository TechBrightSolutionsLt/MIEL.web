@model MIEL.web.Models.ViewModel.PurchaseVM
@{
    ViewData["Title"] = "Create Purchase";
    Layout = "_AdminLayout";
}

<link href="~/css/purchase.css" rel="stylesheet" />

<div class="container-fluid">

    <div class="page-header">
        <h4>Create Purchase</h4>
    </div>

    <form asp-action="Create" method="post">

        <!-- ================= PURCHASE DETAILS ================= -->
        <div class="card mb-4">
            <div class="card-header">Purchase Details</div>
            <div class="card-body">
                <div class="row g-3">

                    <div class="col-md-4">
                        <label class="form-label">Purchase No</label>
                        <input asp-for="PurchaseCode" class="form-control" readonly />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Purchase Date</label>
                        <input asp-for="PurchaseDate" type="date" class="form-control" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Batch No</label>
                        <input asp-for="BatchNo" class="form-control" readonly />
                    </div>

                </div>
            </div>
        </div>

        <!-- ================= SUPPLIER ================= -->
        <div class="card mb-4">
            <div class="card-header">Supplier</div>
            <div class="card-body">
                <div class="col-md-6">
                    <label class="form-label">Supplier</label>
                    <select asp-for="SupplierId"
                            asp-items="Model.Suppliers"
                            class="form-select">
                        <option value="">-- Select Supplier --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ================= ADD PRODUCT ================= -->
        <div class="card mb-4">
            <div class="card-header">Add Product</div>
            <div class="card-body">

                <div class="row g-3">

                  
                        <div class="col-md-4">
                            <label class="form-label">Product</label>

                            <select id="ProductId"
                                    asp-for="ProductId"
                                    class="form-select">
                                <option value="">-- Search Product --</option>
                            </select>
                        </div>
                 

                    <div class="col-md-2">
                        <label class="form-label">Color</label>
                        <input id="Color"
                               name="Color"
                               class="form-control"
                               placeholder="Red" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Size</label>
                        <input id="Size"
                               name="Size"
                               class="form-control"
                               placeholder="M" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Variant Code</label>
                        <input id="VariantCode"
                               name="VariantCode"
                               class="form-control"
                               readonly />
                        <input type="hidden" asp-for="VariantId" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Cost Price</label>
                        <input asp-for="CostPrice"
                               class="form-control"
                               type="number"
                               step="0.01" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Quantity</label>
                        <input asp-for="Quantity"
                               class="form-control"
                               type="number"
                               min="1" />
                    </div>

                    <div class="col-md-6 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100">
                            + Add Item
                        </button>
                    </div>

                </div>

            </div>
        </div>

        <!-- ================= ITEMS GRID ================= -->
        <div class="card mb-4">
            <div class="card-header">Purchase Items</div>
            <div class="card-body p-0">

                <table class="table table-bordered table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Variant</th>
                            <th>Rate</th>
                            <th>Qty</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <td>@item.ProductName</td>
                                <td>@item.VariantCode</td>
                                <td>@item.Rate</td>
                                <td>@item.Quantity</td>
                                <td>@item.Amount</td>
                            </tr>
                        }
                    </tbody>
                </table>

            </div>
        </div>

        <!-- ================= SAVE ================= -->
        <div class="text-end">
            <button type="submit" class="btn btn-success px-5">
                Save Purchase
            </button>
        </div>

    </form>
</div>

<!-- ================= SCRIPT ================= -->
<script>
    $(document).ready(function () {

        $('#ProductId').select2({
            width: '100%',
            placeholder: '-- Search Product --',
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: '/Purchase/SearchProducts',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { term: params.term };
                },
                processResults: function (data) {
                    return { results: data };
                }
            }
        });

        $('#ProductId').on('select2:select', function () {
            generateVariantCodeFromProduct();
        });

        $('#Color, #Size').on('keyup', generateVariantCodeFromProduct);
    });

    function generateVariantCodeFromProduct() {

        let productText = $('#ProductId option:selected').text();
        let color = $('#Color').val();
        let size = $('#Size').val();

        if (!productText || productText.includes('Search') || !color || !size) {
            $('#VariantCode').val('');
            return;
        }

        let code =
            productText.trim().toUpperCase().replace(/\s+/g, '-') + '-' +
            color.trim().toUpperCase() + '-' +
            size.trim().toUpperCase();

        $('#VariantCode').val(code);
    }
</script>


